BootStrap: docker
From: nvidia/cuda:12.3.2-cudnn9-runtime-ubuntu22.04

%post
    TZ=Europe/Berlin
    ln -snf /usr/share/zoneinfo/${TZ} /etc/localtime && echo ${TZ} > /etc/timezone

    apt-get clean
    rm -rf /var/lib/apt/lists/*
    apt-get update -qq

    DEBIAN_FRONTEND=noninteractive apt-get install -y software-properties-common git
    add-apt-repository -y ppa:deadsnakes/ppa
    apt-get update -qq
    DEBIAN_FRONTEND=noninteractive apt-get install -y python3.10 python3.10-dev python3-pip python3.10-venv
    update-alternatives --install /usr/bin/python python /usr/bin/python3.10 10

%environment
    # Set this in the environment block so the venv is on PATH by default when container runs
    export PATH="/env/bin:$PATH"
    # Define the expected bind-mount target for the project root inside the container
    export HYPERLAX_ROOT="/opt/hyperlax"
    # Set a base PYTHONPATH, which will be extended by hyperlax_setup.sh
    export PYTHONPATH="$PYTHONPATH:${HYPERLAX_ROOT}"

%runscript
    # This is the default command executed if the container is run without specifying a command.
    echo "Hello World. This is the HyperLaX Singularity container."
    exec "$@"

%files
    ../requirements/requirements.txt /deps/requirements.txt

%post
    python3.10 -m venv /env
    . /env/bin/activate
    which python
    which pip
    pip install -r /deps/requirements.txt

    # Install core, non-project-specific Python dependencies into the venv.
    # Project-specific requirements from requirements.txt will be installed at runtime via bind-mount.
    /env/bin/pip install -U "jax[cuda12_pip]==0.4.28" -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

    echo "JAX installed into /env venv inside container."
